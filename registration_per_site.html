<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourist Site Registration</title>
    <link rel="stylesheet" href="css/per_site.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js" defer></script>
</head>
<body>
    <div class="container">
        <h2>Tourist Site Registration</h2>
        <label for="registrationNumber">Enter Registration Number:</label>
        <input type="text" id="registrationNumber" placeholder="Enter your registration number">
        <button onclick="fetchDetails()">Fetch Details</button>

        <p id="error" class="error"></p>

        <div id="touristDetails" class="tourist-details" style="display:none;">
            <h3>Tourist Details</h3>
            <p><strong>Registered Tourists:</strong></p>

            <table id="touristTable" border="1">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Tourist Name</th>
                        <th>Age</th>
                        <th>Sex</th>
                        <th>Nationality</th>
                    </tr>
                </thead>
                <tbody id="touristList"></tbody>
            </table>

            <label for="siteSelect">Select Tourist Site:</label>
            <select id="siteSelect">
                <option value="Paytokan Walk">Paytokan Walk</option>
                <option value="Hanging Coffins">Hanging Coffins</option>
                <option value="Langsayan">Langsayan</option>
                <option value="Marlboro">Marlboro</option>
                <option value="Marlboro to Blue Soil">Marlboro to Blue Soil</option>
                <option value="Blue Soil">Blue Soil</option>
                <option value="Ampacao">Ampacao</option>
                <option value="Nabas-ang to Ampacao">Nabas-ang to Ampacao</option>
                <option value="Bomod-ok Falls">Bomod-ok Falls</option>
                <option value="Bokong Falls">Bokong Falls</option>
                <option value="Pongas Falls">Pongas Falls</option>
                <option value="Sumaguing Cave">Sumaguing Cave</option>
                <option value="Lumiang Cave">Lumiang Cave</option>
                <option value="Balangagan Cave">Balangagan Cave</option>
                <option value="Sumaguing Entrance - Sight Seeing">Sumaguing Entrance - Sight Seeing</option>
                <option value="Lumiang Entrance - Sight Seeing">Lumiang Entrance - Sight Seeing</option>
            </select>
            <button onclick="submitAttendance()">Submit Attendance</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCt1EginvMZvYdlrseVPBiyvfto4bvED5Y",
            authDomain: "sagadatouristregister.firebaseapp.com",
            projectId: "sagadatouristregister",
            storageBucket: "sagadatouristregister.firebasestorage.app",
            messagingSenderId: "875774905793",
            appId: "1:875774905793:web:d4fe2ea42fedba8d473340",
            measurementId: "G-2VF5GCQGZ1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function calculateAge(dob) {
            let birthDate = new Date(dob);
            let today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            let monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function getNationality(country) {
            const nationalityMap = {
                "Afghanistan": "Afghan", "Albania": "Albanian", "Algeria": "Algerian", "Argentina": "Argentine", "Australia": "Australian", "Austria": "Austrian", "Bangladesh": "Bangladeshi", "Belgium": "Belgian", "Brazil": "Brazilian", "Canada": "Canadian", "China": "Chinese", "Denmark": "Danish", "Egypt": "Egyptian", "France": "French", "Germany": "German", "India": "Indian", "Indonesia": "Indonesian", "Italy": "Italian", "Japan": "Japanese", "Mexico": "Mexican", "Netherlands": "Dutch", "Norway": "Norwegian", "Pakistan": "Pakistani", "Philippines": "Filipino", "Russia": "Russian", "Saudi Arabia": "Saudi", "South Korea": "South Korean", "Spain": "Spanish", "Sweden": "Swedish", "Switzerland": "Swiss", "Thailand": "Thai", "United Kingdom": "British", "United States": "American", "Vietnam": "Vietnamese" 
            };
            return nationalityMap[country] || "Unknown";
        }

        async function fetchDetails() {
            document.getElementById("error").textContent = "";
            document.getElementById("touristList").innerHTML = "";
            let regNumber = document.getElementById("registrationNumber").value.trim();

            if (!regNumber) {
                document.getElementById("error").textContent = "Please enter a registration number.";
                return;
            }

            try {
                const q = query(collection(db, "registrations"), where("registrationNumber", "==", regNumber));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    let touristListDiv = document.getElementById("touristList");
                    touristListDiv.innerHTML = "";

                    querySnapshot.forEach(docSnap => {
                        let data = docSnap.data();
                        let tourists = [];

                        if (data.fullName) {
                            tourists.push({ name: data.fullName, age: calculateAge(data.dateOfBirth), sex: data.sex, nationality: getNationality(data.country) });
                        } else if (data.groupMembers && Array.isArray(data.groupMembers)) {
                            tourists = data.groupMembers.map(member => ({ name: member.memberName, age: calculateAge(member.memberDOB), sex: member.memberSex, nationality: getNationality(data.groupCountry) }));
                        }

                        tourists.forEach(tourist => {
                            let row = `<tr>
                                <td><input type="checkbox" value="${tourist.name}"></td>
                                <td>${tourist.name}</td>
                                <td>${tourist.age}</td>
                                <td>${tourist.sex}</td>
                                <td>${tourist.nationality}</td>
                            </tr>`;
                            touristListDiv.innerHTML += row;
                        });
                    });
                    document.getElementById("touristDetails").style.display = "block";
                } else {
                    document.getElementById("error").textContent = "Registration number not found.";
                }
            } catch (error) {
                document.getElementById("error").textContent = "Error fetching data: " + error.message;
            }
        }

        async function submitAttendance() {
            let selectedSite = document.getElementById("siteSelect").value;
            let checkedTourists = document.querySelectorAll("#touristList input[type='checkbox']:checked");
            let registrationNumber = document.getElementById("registrationNumber").value.trim();

            if (checkedTourists.length === 0) {
                alert("Please select at least one tourist.");
                return;
            }

            try {
                let tourists = [];
        
                for (let checkbox of checkedTourists) {
                    let row = checkbox.closest("tr").children;
                    let name = row[1].textContent;
                    let age = row[2].textContent;
                    let sex = row[3].textContent;
                    let nationality = row[4].textContent;

                    tourists.push({
                        name: name,
                        age: parseInt(age),
                        sex: sex,
                        nationality: nationality
                    });
                }

                if (tourists.length === 1) {
                    // Individual Tourist Entry
                    await addDoc(collection(db, "attendance"), {
                        registrationNumber: registrationNumber,
                        name: tourists[0].name,
                        age: tourists[0].age,
                        sex: tourists[0].sex,
                        nationality: tourists[0].nationality,
                        site: selectedSite,
                        timestamp: new Date()
                    });
                } else {
                    // Group Attendance Entry
                    await addDoc(collection(db, "attendance"), {
                        registrationNumber: registrationNumber,
                        groupMembers: tourists, 
                        site: selectedSite,
                        timestamp: new Date()
                    });
                }

                alert("Attendance recorded successfully!");
                document.getElementById("touristDetails").style.display = "none"; 
                document.getElementById("registrationNumber").value = ""; 
                document.getElementById("touristList").innerHTML = "";  
            } catch (error) {
                console.error("Error submitting attendance: ", error);
                alert("Error saving attendance. Please try again.");
            }
        }



        window.fetchDetails = fetchDetails;
        window.submitAttendance = submitAttendance;
    </script>
</body>
</html>
