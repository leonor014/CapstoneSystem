<!DOCTYPE html>   
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourist Site Registration</title>
    <link rel="stylesheet" href="css/per_site.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js" defer></script>
</head>
<body>
    <div class="container">
        <h2>Tourist Site Registration</h2>
        <label for="registrationNumber">Enter Registration Number:</label>
        <input type="text" id="registrationNumber" placeholder="Enter your registration number">
        <button onclick="fetchDetails()">Fetch Details</button>

        <p id="error" class="error"></p>

        <div id="touristDetails" class="tourist-details" style="display:none;">
            <h3>Tourist Details</h3>
            <p><strong>Registered Tourists:</strong></p>

            <table id="touristTable" border="1">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Tourist Name</th>
                        <th>Age</th>
                        <th>Sex</th>
                        <th>Nationality</th>
                    </tr>
                </thead>
                <tbody id="touristList"></tbody>
            </table>

            <label for="siteSelect">Select Tourist Site:</label>
            <select id="siteSelect">
                <option value="Paytokan Walk">Paytokan Walk</option>
                <option value="Hanging Coffins">Hanging Coffins</option>
                <option value="Langsayan">Langsayan</option>
                <option value="Marlboro">Marlboro</option>
                <option value="Marlboro to Blue Soil">Marlboro to Blue Soil</option>
                <option value="Blue Soil">Blue Soil</option>
                <option value="Ampacao">Ampacao</option>
                <option value="Nabas-ang to Ampacao">Nabas-ang to Ampacao</option>
                <option value="Bomod-ok Falls">Bomod-ok Falls</option>
                <option value="Bokong Falls">Bokong Falls</option>
                <option value="Pongas Falls">Pongas Falls</option>
                <option value="Sumaguing Cave">Sumaguing Cave</option>
                <option value="Lumiang Cave">Lumiang Cave</option>
                <option value="Balangagan Cave">Balangagan Cave</option>
                <option value="Sumaguing Entrance - Sight Seeing">Sumaguing Entrance - Sight Seeing</option>
                <option value="Lumiang Entrance - Sight Seeing">Lumiang Entrance - Sight Seeing</option>
            </select>
            <button onclick="submitAttendance()">Submit Attendance</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCt1EginvMZvYdlrseVPBiyvfto4bvED5Y",
            authDomain: "sagadatouristregister.firebaseapp.com",
            projectId: "sagadatouristregister",
            storageBucket: "sagadatouristregister.firebasestorage.app",
            messagingSenderId: "875774905793",
            appId: "1:875774905793:web:d4fe2ea42fedba8d473340",
            measurementId: "G-2VF5GCQGZ1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function calculateAge(dob) {
            if (!dob) return "-";
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }


        const countryToNationality = {
            "Afghanistan": "Afghan", "Albania": "Albanian", "Algeria": "Algerian", "Argentina": "Argentine", "Australia": "Australian", "Austria": "Austrian", "Bangladesh": "Bangladeshi", "Belgium": "Belgian", "Brazil": "Brazilian", "Canada": "Canadian", "China": "Chinese", "Colombia": "Colombian", "Denmark": "Danish", "Egypt": "Egyptian", "Finland": "Finnish", "France": "French", "Germany": "German", "Greece": "Greek", "India": "Indian", "Indonesia": "Indonesian", "Iran": "Iranian", "Iraq": "Iraqi", "Ireland": "Irish", "Italy": "Italian", "Japan": "Japanese", "Malaysia": "Malaysian", "Mexico": "Mexican", "Netherlands": "Dutch", "New Zealand": "New Zealander", "Norway": "Norwegian", "Pakistan": "Pakistani", "Peru": "Peruvian", "Philippines": "Filipino", "Poland": "Polish", "Portugal": "Portuguese", "Russia": "Russian", "Saudi Arabia": "Saudi", "Singapore": "Singaporean", "South Africa": "South African", "South Korea": "South Korean", "Spain": "Spanish", "Sri Lanka": "Sri Lankan", "Sweden": "Swedish", "Switzerland": "Swiss", "Thailand": "Thai", "Turkey": "Turkish", "United Kingdom": "British", "United States": "American", "Vietnam": "Vietnamese", "Zimbabwe": "Zimbabwean"
        };

        function getNationality(country) {
            return countryToNationality[country] || "Unknown";
        }

        async function fetchDetails() {
            document.getElementById("error").textContent = "";
            document.getElementById("touristList").innerHTML = "";
            let regNumber = document.getElementById("registrationNumber").value.trim();

            if (!regNumber) {
                document.getElementById("error").textContent = "Please enter a registration number.";
                return;
            }

            try {
                const q = query(collection(db, "registrations"), where("registrationNumber", "==", regNumber));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    let touristListDiv = document.getElementById("touristList");
                    touristListDiv.innerHTML = "";
                    document.getElementById("touristDetails").style.display = "block";

                    querySnapshot.forEach(docSnap => {
                        let data = docSnap.data();
                        let tourists = data.fullName ? [{...data, memberName: data.fullName, memberDOB: data.dateOfBirth, memberSex: data.sex, nationality: getNationality(data.country)}] : data.groupMembers.map(member => ({...member, nationality: getNationality(data.groupCountry)}));

                        tourists.forEach(tourist => {
                            let row = document.createElement("tr");
                            row.innerHTML = `
                                <td><input type="checkbox" value="${tourist.memberName}" id="${tourist.memberName}"></td>
                                <td>${tourist.memberName || "Unknown"}</td>
                                <td>${calculateAge(tourist.memberDOB)}</td>
                                <td>${tourist.memberSex || "Unknown"}</td>
                                <td>${tourist.nationality}</td>
                            `;
                            touristListDiv.appendChild(row);
                        });
                    });
                } else {
                    document.getElementById("error").textContent = "Registration number not found.";
                }
            } catch (error) {
                document.getElementById("error").textContent = "Error fetching data: " + error.message;
            }
        }

        async function submitAttendance() {
            const selectedTourists = document.querySelectorAll('#touristList input:checked');
            if (selectedTourists.length === 0) {
                alert("Please select at least one tourist.");
                return;
            }

            const site = document.getElementById("siteSelect").value;
            const attendanceData = [];

            selectedTourists.forEach(checkbox => {
                const row = checkbox.closest("tr");
                attendanceData.push({
                    name: row.cells[1].textContent,
                    age: row.cells[2].textContent,
                    sex: row.cells[3].textContent,
                    nationality: row.cells[4].textContent,
                    site: site,
                    timestamp: new Date().toISOString()
                });
            });

            try {
                await addDoc(collection(db, "attendance"), { records: attendanceData });
                alert("Attendance submitted successfully!");
            } catch (error) {
                alert("Error submitting attendance: " + error.message);
            }
        }


        window.fetchDetails = fetchDetails;
        window.submitAttendance = function() {
            alert("Attendance submitted successfully!");
        };
    </script>
</body>
</html>
