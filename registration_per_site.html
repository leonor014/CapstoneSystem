<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourist Site Registration</title>
    <link rel="stylesheet" href="css/per_site.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js" defer></script>
</head>
<body>
    <div class="container">
        <h2>Tourist Site Registration</h2>
        <label for="registrationNumber">Enter Registration Number:</label>
        <input type="text" id="registrationNumber" placeholder="Enter your registration number">
        <button onclick="fetchDetails()">Fetch Details</button>

        <p id="error" class="error"></p>

        <div id="touristDetails" class="tourist-details" style="display:none;">
            <h3>Tourist Details</h3>
            <p><strong>Registered Tourists:</strong></p>

            <!-- ðŸ”¹ TABLE FOR TOURIST NAMES -->
            <table id="touristTable" border="1">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Tourist Name</th>
                    </tr>
                </thead>
                <tbody id="touristList"></tbody>
            </table>

            <label for="siteSelect">Select Tourist Site:</label>
            <select id="siteSelect">
                <option value="Site A">Site A</option>
                <option value="Site B">Site B</option>
                <option value="Site C">Site C</option>
            </select>
            <button onclick="submitAttendance()">Submit Attendance</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCt1EginvMZvYdlrseVPBiyvfto4bvED5Y",
            authDomain: "sagadatouristregister.firebaseapp.com",
            projectId: "sagadatouristregister",
            storageBucket: "sagadatouristregister.firebasestorage.app",
            messagingSenderId: "875774905793",
            appId: "1:875774905793:web:d4fe2ea42fedba8d473340",
            measurementId: "G-2VF5GCQGZ1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ðŸ”¹ Fetch Tourist Details and Display in Table
        async function fetchDetails() {
            document.getElementById("error").textContent = "";
            let regNumber = document.getElementById("registrationNumber").value.trim();

            if (!regNumber) {
                document.getElementById("error").textContent = "Please enter a registration number.";
                return;
            }

            try {
                // Query Firestore
                const q = query(collection(db, "registrations"), where("registrationNumber", "==", regNumber));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    let docSnap = querySnapshot.docs[0]; 
                    let tourists = docSnap.data().tourists || [];

                    let touristListDiv = document.getElementById("touristList");
                    touristListDiv.innerHTML = ""; // Clear previous entries

                    tourists.forEach(name => {
                        let row = document.createElement("tr");

                        let checkboxCell = document.createElement("td");
                        let checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.value = name;
                        checkbox.id = name;

                        let label = document.createElement("label");
                        label.setAttribute("for", name);
                        label.textContent = name;

                        checkboxCell.appendChild(checkbox);
                        let nameCell = document.createElement("td");
                        nameCell.appendChild(label);

                        row.appendChild(checkboxCell);
                        row.appendChild(nameCell);
                        touristListDiv.appendChild(row);
                    });

                    document.getElementById("touristDetails").style.display = "block";
                } else {
                    document.getElementById("error").textContent = "Registration number not found.";
                }
            } catch (error) {
                document.getElementById("error").textContent = "Error fetching data: " + error.message;
                console.error("Fetch Error:", error);
            }
        }

        // ðŸ”¹ Submit Attendance
        async function submitAttendance() {
            let regNumber = document.getElementById("registrationNumber").value.trim();
            let site = document.getElementById("siteSelect").value;
            let selectedTourists = [];
            
            document.querySelectorAll("#touristList input:checked").forEach(checkbox => {
                selectedTourists.push(checkbox.value);
            });

            if (selectedTourists.length === 0) {
                document.getElementById("error").textContent = "Please select at least one tourist.";
                return;
            }

            try {
                await setDoc(doc(db, "attendance", regNumber), {
                    site: site,
                    attendees: selectedTourists
                });

                alert(`Attendance marked successfully for ${selectedTourists.join(", ")} at ${site}.`);
            } catch (error) {
                document.getElementById("error").textContent = "Error marking attendance: " + error.message;
                console.error("Submit Error:", error);
            }
        }

        // Attach functions to global scope
        window.fetchDetails = fetchDetails;
        window.submitAttendance = submitAttendance;
    </script>

</body>
</html>
